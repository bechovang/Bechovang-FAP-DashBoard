console.log("Background script loaded.");async function r(e,t){await chrome.scripting.executeScript({target:{tabId:e},files:[t]})}function c(e){chrome.runtime.sendMessage({action:"updateStatus",data:e})}chrome.runtime.onMessage.addListener((e,t,o)=>(e.action==="startScraping"?(console.log("Nhận được yêu cầu cào dữ liệu..."),i(),o({status:"Đã nhận lệnh, đang xử lý..."})):e.action==="downloadJson"&&chrome.storage.local.get("scrapedData",a=>{const n=a.scrapedData;if(n){const s="data:text/json;charset=utf-t,"+encodeURIComponent(JSON.stringify(n,null,2));chrome.downloads.download({url:s,filename:"fap_data.json",saveAs:!0})}}),!0));async function i(){try{const e="https://fap.fpt.edu.vn/Exam/ScheduleExams.aspx";c("Đang mở trang Lịch thi...");const t=await chrome.tabs.create({url:e,active:!1});t.id&&chrome.tabs.onUpdated.addListener(async function o(a,n){a===t.id&&n.status==="complete"&&(chrome.tabs.onUpdated.removeListener(o),c("Đang cào dữ liệu Lịch thi..."),await r(t.id,"content-scripts/fap-scraper.js"))})}catch(e){console.error("Lỗi trong quá trình cào dữ liệu:",e),c(`Đã xảy ra lỗi: ${e.message}`)}}chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.action==="scrapedData"){const a=e.data;console.log("Đã nhận dữ liệu từ content script:",a),c("Đã nhận dữ liệu, đang lưu trữ...");const n={examSchedule:a};chrome.storage.local.set({scrapedData:n},()=>{console.log("Dữ liệu đã được lưu vào chrome.storage.local"),chrome.runtime.sendMessage({action:"scrapingComplete"})})}});
