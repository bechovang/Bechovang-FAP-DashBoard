console.log("Background script loaded.");async function s(e,t){await chrome.scripting.executeScript({target:{tabId:e},files:[t]})}function o(e){chrome.runtime.sendMessage({action:"updateStatus",data:e})}function d(e,t){chrome.storage.local.get("scrapedData",a=>{if(console.log("== DOWNLOAD FLOW: Dữ liệu lấy từ storage:",a),a&&a.scrapedData){let r;switch(e){case"all":r=a.scrapedData;break;case"exam":r={examSchedule:a.scrapedData.examSchedule||[]};break;case"curriculum":r={curriculum:a.scrapedData.curriculum||{}};break;case"profile":r={profile:a.scrapedData.profile||{}};break;default:console.error("== DOWNLOAD FLOW: Loại tải không hợp lệ:",e);return}const n="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(r,null,2));console.log("== DOWNLOAD FLOW: Chuẩn bị tải xuống file:",t);try{chrome.downloads.download({url:n,filename:t,saveAs:!0},c=>{chrome.runtime.lastError?console.error("== DOWNLOAD FLOW: Lỗi khi tải file:",chrome.runtime.lastError):console.log("== DOWNLOAD FLOW: Tải file thành công, downloadId:",c)})}catch(c){console.error("== DOWNLOAD FLOW: Lỗi khi gọi chrome.downloads.download:",c)}}else console.error("== DOWNLOAD FLOW: Không tìm thấy 'scrapedData' trong storage.")})}chrome.runtime.onMessage.addListener((e,t,a)=>(e.action==="startScraping"?(console.log("Nhận được yêu cầu cào dữ liệu..."),T(),a({status:"Đã nhận lệnh, đang xử lý..."})):e.action==="downloadAll"?(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải tất cả dữ liệu."),d("all","fap_data_complete.json")):e.action==="downloadExam"?(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải dữ liệu lịch thi."),d("exam","fap_exam_schedule.json")):e.action==="downloadCurriculum"?(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải dữ liệu chương trình học."),d("curriculum","fap_curriculum.json")):e.action==="downloadProfile"?(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải dữ liệu profile."),d("profile","fap_profile.json")):e.action==="scrapeHTMLPage"?(console.log(`Nhận được yêu cầu cào HTML trang: ${e.pageType}`),J(e.pageType),a({status:"Đang mở trang để cào HTML..."})):e.action==="scrapeCurrentPage"?(console.log("Nhận được yêu cầu cào HTML trang hiện tại"),A(),a({status:"Đang cào HTML trang hiện tại..."})):e.action==="scrapeScheduleJSON"?(console.log("Nhận được yêu cầu cào JSON lịch học tuần"),U(),a({status:"Đang mở trang lịch tuần để cào JSON..."})):e.action==="scrapeGradeJSON"&&(console.log("Nhận được yêu cầu cào JSON điểm từ các link:",e.urls),k(e.urls),a({status:"Đang bắt đầu cào điểm từ các môn học..."})),!0));async function T(){try{o("Bắt đầu cào dữ liệu..."),await v(),await M(),await x()}catch(e){console.error("Lỗi trong quá trình cào dữ liệu:",e),o(`Đã xảy ra lỗi: ${e.message}`)}}async function M(){try{const e="https://fap.fpt.edu.vn/Exam/ScheduleExams.aspx";o("Đang mở trang Lịch thi...");const t=await chrome.tabs.create({url:e,active:!1});t.id&&chrome.tabs.onUpdated.addListener(async function a(r,n){r===t.id&&n.status==="complete"&&(chrome.tabs.onUpdated.removeListener(a),o("Đang cào dữ liệu Lịch thi..."),await s(t.id,"content-scripts/fap-scraper.js"))})}catch(e){console.error("Lỗi trong quá trình cào dữ liệu lịch thi:",e),o(`Đã xảy ra lỗi: ${e.message}`)}}async function x(){try{const e="https://fap.fpt.edu.vn/FrontOffice/StudentCurriculum.aspx";o("Đang mở trang Chương trình học...");const t=await chrome.tabs.create({url:e,active:!1});t.id&&chrome.tabs.onUpdated.addListener(async function a(r,n){r===t.id&&n.status==="complete"&&(chrome.tabs.onUpdated.removeListener(a),o("Đang cào dữ liệu Chương trình học..."),await s(t.id,"content-scripts/fap-curriculum-scraper.js"))})}catch(e){console.error("Lỗi trong quá trình cào dữ liệu chương trình học:",e),o(`Đã xảy ra lỗi: ${e.message}`)}}async function v(){try{const e="https://fap.fpt.edu.vn/User/Profile.aspx";o("Đang mở trang Profile...");const t=await chrome.tabs.create({url:e,active:!1});t.id&&chrome.tabs.onUpdated.addListener(async function a(r,n){r===t.id&&n.status==="complete"&&(chrome.tabs.onUpdated.removeListener(a),o("Đang cào dữ liệu Profile..."),await s(t.id,"content-scripts/fap-profile-scraper.js"))})}catch(e){console.error("Lỗi trong quá trình cào dữ liệu profile:",e),o(`Đã xảy ra lỗi: ${e.message}`)}}let u=null,h=null,m=null;chrome.runtime.onMessage.addListener((e,t,a)=>{if(e.action==="scrapedData"){const r=e.data;console.log("Đã nhận dữ liệu lịch thi từ content script:",r),o("Đã nhận dữ liệu lịch thi..."),h=r,L()}else if(e.action==="scrapedCurriculumData"){const r=e.data;console.log("Đã nhận dữ liệu chương trình học từ content script:",r),o("Đã nhận dữ liệu chương trình học..."),m=r,L()}else if(e.action==="scrapedProfileData"){const r=e.data;console.log("Đã nhận dữ liệu profile từ content script:",r),o("Đã nhận dữ liệu profile..."),u=r,L()}else if(e.action==="scrapedHTMLData"){const r=e.data;console.log("Đã nhận dữ liệu HTML từ content script:",r.fileName),o("Đang tải file HTML..."),E(r.content,r.fileName)}else if(e.action==="scrapedScheduleJSON"){const r=e.data;console.log("Đã nhận dữ liệu JSON lịch học từ content script:",r.fileName),o("Đang tải file JSON lịch học..."),D(r.content,r.fileName)}else if(e.action==="scrapedGradeJSON"){const r=e.data;if(console.log("Đã nhận dữ liệu JSON điểm từ content script:",r.fileName),r.gradeData&&r.gradeData.semesters)for(const n of r.gradeData.semesters){let c=S.get(n.term);c||(c={term:n.term,courses:[]},S.set(n.term,c),O.semesters.push(c));for(const l of n.courses)c.courses.push(l)}p=!0,o("Đã thu thập dữ liệu điểm, đang tiếp tục...")}});function L(){if(u&&h&&m){o("Đang lưu trữ tất cả dữ liệu...");const e={profile:u,examSchedule:h,curriculum:m};chrome.storage.local.set({scrapedData:e},()=>{console.log("== SAVE FLOW: Tất cả dữ liệu đã được LƯU THÀNH CÔNG vào storage."),u=null,h=null,m=null,chrome.runtime.sendMessage({action:"scrapingComplete"})})}}async function J(e){try{let t="";switch(e){case"weekly-schedule":t="https://fap.fpt.edu.vn/Report/ScheduleOfWeek.aspx";break;case"exam-schedule":t="https://fap.fpt.edu.vn/Exam/ScheduleExams.aspx";break;case"student-grades":t="https://fap.fpt.edu.vn/Grade/StudentGrade.aspx";break;case"attendance-report":t="https://fap.fpt.edu.vn/Report/ViewAttendstudent.aspx";break;default:throw new Error(`Loại trang không được hỗ trợ: ${e}`)}o(`Đang mở trang ${e}...`);const a=await chrome.tabs.create({url:t,active:!1});a.id&&chrome.tabs.onUpdated.addListener(async function r(n,c){n===a.id&&c.status==="complete"&&(chrome.tabs.onUpdated.removeListener(r),o(`Đang cào HTML từ ${e}...`),await s(a.id,"content-scripts/html-scraper.js"),setTimeout(async()=>{try{a.id&&await chrome.tabs.remove(a.id)}catch{console.log("Tab có thể đã được đóng trước đó")}},5e3))})}catch(t){console.error(`Lỗi trong quá trình cào HTML ${e}:`,t),o(`Lỗi: ${t.message}`),chrome.runtime.sendMessage({action:"htmlScrapingError",error:t.message})}}async function A(){try{const t=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0];if(!t||!t.id)throw new Error("Không thể tìm thấy tab hiện tại");if(!t.url||!t.url.includes("fap.fpt.edu.vn"))throw new Error("Tab hiện tại không phải là trang FAP");o("Đang cào HTML từ trang hiện tại..."),await s(t.id,"content-scripts/html-scraper.js")}catch(e){console.error("Lỗi trong quá trình cào HTML trang hiện tại:",e),o(`Lỗi: ${e.message}`),chrome.runtime.sendMessage({action:"htmlScrapingError",error:e.message})}}function E(e,t){const a="data:text/plain;charset=utf-8,"+encodeURIComponent(e);console.log("== HTML DOWNLOAD FLOW: Chuẩn bị tải xuống file HTML:",t);try{chrome.downloads.download({url:a,filename:t,saveAs:!0},r=>{chrome.runtime.lastError?(console.error("== HTML DOWNLOAD FLOW: Lỗi khi tải file:",chrome.runtime.lastError),chrome.runtime.sendMessage({action:"htmlScrapingError",error:chrome.runtime.lastError.message})):(console.log("== HTML DOWNLOAD FLOW: Tải file thành công, downloadId:",r),chrome.runtime.sendMessage({action:"htmlScrapingComplete",fileName:t}))})}catch(r){console.error("== HTML DOWNLOAD FLOW: Lỗi khi gọi chrome.downloads.download:",r),chrome.runtime.sendMessage({action:"htmlScrapingError",error:r.message})}}function D(e,t){const a="data:application/json;charset=utf-8,"+encodeURIComponent(e);console.log("== JSON DOWNLOAD FLOW: Chuẩn bị tải xuống file JSON:",t);try{chrome.downloads.download({url:a,filename:t,saveAs:!0},r=>{chrome.runtime.lastError?(console.error("== JSON DOWNLOAD FLOW: Lỗi khi tải file:",chrome.runtime.lastError),chrome.runtime.sendMessage({action:"scheduleJSONScrapingError",error:chrome.runtime.lastError.message})):(console.log("== JSON DOWNLOAD FLOW: Tải file thành công, downloadId:",r),chrome.runtime.sendMessage({action:"scheduleJSONScrapingComplete",fileName:t}))})}catch(r){console.error("== JSON DOWNLOAD FLOW: Lỗi khi gọi chrome.downloads.download:",r),chrome.runtime.sendMessage({action:"scheduleJSONScrapingError",error:r.message})}}async function U(){try{const e="https://fap.fpt.edu.vn/Report/ScheduleOfWeek.aspx";o("Đang mở trang lịch học tuần...");const t=await chrome.tabs.create({url:e,active:!1});t.id&&chrome.tabs.onUpdated.addListener(async function a(r,n){r===t.id&&n.status==="complete"&&(chrome.tabs.onUpdated.removeListener(a),o("Đang cào JSON lịch học tuần..."),await s(t.id,"content-scripts/schedule-json-scraper.js"),setTimeout(async()=>{try{t.id&&await chrome.tabs.remove(t.id)}catch{console.log("Tab có thể đã được đóng trước đó")}},5e3))})}catch(e){console.error("Lỗi trong quá trình cào JSON lịch học tuần:",e),o(`Lỗi: ${e.message}`),chrome.runtime.sendMessage({action:"scheduleJSONScrapingError",error:e.message})}}let O={lastUpdated:new Date().toISOString(),semesters:[]};const S=new Map;let p=!1;async function k(e){try{O={lastUpdated:new Date().toISOString(),semesters:[]},S.clear(),p=!1,o(`Đang cào điểm từ ${e.length} môn học...`);for(let r=0;r<e.length;r++){const n=e[r];chrome.runtime.sendMessage({action:"gradeJSONScrapingProgress",current:r+1,total:e.length});try{const c=await chrome.tabs.create({url:n,active:!1});if(c.id){await new Promise((i,w)=>{const b=setTimeout(()=>{chrome.tabs.onUpdated.removeListener(g),w(new Error("Timeout waiting for page to load"))},3e4),g=async(y,W)=>{if(y===c.id&&W.status==="complete"){clearTimeout(b),chrome.tabs.onUpdated.removeListener(g);try{await s(c.id,"content-scripts/grade-json-scraper.js"),await new Promise(f=>setTimeout(f,3e3)),i()}catch(f){w(f)}}};chrome.tabs.onUpdated.addListener(g)});let l=0;const N=1e4;for(;!p&&l<N;)await new Promise(i=>setTimeout(i,500)),l+=500;p=!1;try{await chrome.tabs.remove(c.id)}catch(i){console.log("Tab có thể đã được đóng trước đó:",i)}await new Promise(i=>setTimeout(i,1e3))}}catch(c){console.error(`Lỗi khi cào điểm từ URL ${n}:`,c)}}const t=`fap-grades-combined-${new Date().toISOString().replace(/[:.]/g,"-")}.json`,a=JSON.stringify(O,null,2);D(a,t),chrome.runtime.sendMessage({action:"gradeJSONScrapingComplete",fileName:t}),o(`Đã hoàn thành cào điểm từ ${e.length} môn học và tạo file tổng hợp!`)}catch(t){console.error("Lỗi trong quá trình cào JSON điểm:",t),o(`Lỗi: ${t.message}`),chrome.runtime.sendMessage({action:"gradeJSONScrapingError",error:t.message})}}
