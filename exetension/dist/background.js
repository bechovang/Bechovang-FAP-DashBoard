console.log("Background script loaded.");async function h(t,a){await chrome.scripting.executeScript({target:{tabId:t},files:[a]})}function c(t){chrome.runtime.sendMessage({action:"updateStatus",data:t})}function n(t,a){chrome.storage.local.get("scrapedData",o=>{if(console.log("== DOWNLOAD FLOW: Dữ liệu lấy từ storage:",o),o&&o.scrapedData){let e;switch(t){case"all":e=o.scrapedData;break;case"exam":e={examSchedule:o.scrapedData.examSchedule||[]};break;case"curriculum":e={curriculum:o.scrapedData.curriculum||{}};break;case"profile":e={profile:o.scrapedData.profile||{}};break;default:console.error("== DOWNLOAD FLOW: Loại tải không hợp lệ:",t);return}const r="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e,null,2));console.log("== DOWNLOAD FLOW: Chuẩn bị tải xuống file:",a);try{chrome.downloads.download({url:r,filename:a,saveAs:!0},u=>{chrome.runtime.lastError?console.error("== DOWNLOAD FLOW: Lỗi khi tải file:",chrome.runtime.lastError):console.log("== DOWNLOAD FLOW: Tải file thành công, downloadId:",u)})}catch(u){console.error("== DOWNLOAD FLOW: Lỗi khi gọi chrome.downloads.download:",u)}}else console.error("== DOWNLOAD FLOW: Không tìm thấy 'scrapedData' trong storage.")})}chrome.runtime.onMessage.addListener((t,a,o)=>(t.action==="startScraping"?(console.log("Nhận được yêu cầu cào dữ liệu..."),p(),o({status:"Đã nhận lệnh, đang xử lý..."})):t.action==="downloadAll"?(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải tất cả dữ liệu."),n("all","fap_data_complete.json")):t.action==="downloadExam"?(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải dữ liệu lịch thi."),n("exam","fap_exam_schedule.json")):t.action==="downloadCurriculum"?(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải dữ liệu chương trình học."),n("curriculum","fap_curriculum.json")):t.action==="downloadProfile"&&(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải dữ liệu profile."),n("profile","fap_profile.json")),!0));async function p(){try{c("Bắt đầu cào dữ liệu..."),await g(),await f(),await m()}catch(t){console.error("Lỗi trong quá trình cào dữ liệu:",t),c(`Đã xảy ra lỗi: ${t.message}`)}}async function f(){try{const t="https://fap.fpt.edu.vn/Exam/ScheduleExams.aspx";c("Đang mở trang Lịch thi...");const a=await chrome.tabs.create({url:t,active:!1});a.id&&chrome.tabs.onUpdated.addListener(async function o(e,r){e===a.id&&r.status==="complete"&&(chrome.tabs.onUpdated.removeListener(o),c("Đang cào dữ liệu Lịch thi..."),await h(a.id,"content-scripts/fap-scraper.js"))})}catch(t){console.error("Lỗi trong quá trình cào dữ liệu lịch thi:",t),c(`Đã xảy ra lỗi: ${t.message}`)}}async function m(){try{const t="https://fap.fpt.edu.vn/FrontOffice/StudentCurriculum.aspx";c("Đang mở trang Chương trình học...");const a=await chrome.tabs.create({url:t,active:!1});a.id&&chrome.tabs.onUpdated.addListener(async function o(e,r){e===a.id&&r.status==="complete"&&(chrome.tabs.onUpdated.removeListener(o),c("Đang cào dữ liệu Chương trình học..."),await h(a.id,"content-scripts/fap-curriculum-scraper.js"))})}catch(t){console.error("Lỗi trong quá trình cào dữ liệu chương trình học:",t),c(`Đã xảy ra lỗi: ${t.message}`)}}async function g(){try{const t="https://fap.fpt.edu.vn/User/Profile.aspx";c("Đang mở trang Profile...");const a=await chrome.tabs.create({url:t,active:!1});a.id&&chrome.tabs.onUpdated.addListener(async function o(e,r){e===a.id&&r.status==="complete"&&(chrome.tabs.onUpdated.removeListener(o),c("Đang cào dữ liệu Profile..."),await h(a.id,"content-scripts/fap-profile-scraper.js"))})}catch(t){console.error("Lỗi trong quá trình cào dữ liệu profile:",t),c(`Đã xảy ra lỗi: ${t.message}`)}}let i=null,l=null,s=null;chrome.runtime.onMessage.addListener((t,a,o)=>{if(t.action==="scrapedData"){const e=t.data;console.log("Đã nhận dữ liệu lịch thi từ content script:",e),c("Đã nhận dữ liệu lịch thi..."),l=e,d()}else if(t.action==="scrapedCurriculumData"){const e=t.data;console.log("Đã nhận dữ liệu chương trình học từ content script:",e),c("Đã nhận dữ liệu chương trình học..."),s=e,d()}else if(t.action==="scrapedProfileData"){const e=t.data;console.log("Đã nhận dữ liệu profile từ content script:",e),c("Đã nhận dữ liệu profile..."),i=e,d()}});function d(){if(i&&l&&s){c("Đang lưu trữ tất cả dữ liệu...");const t={profile:i,examSchedule:l,curriculum:s};chrome.storage.local.set({scrapedData:t},()=>{console.log("== SAVE FLOW: Tất cả dữ liệu đã được LƯU THÀNH CÔNG vào storage."),i=null,l=null,s=null,chrome.runtime.sendMessage({action:"scrapingComplete"})})}}
