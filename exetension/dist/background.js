console.log("Background script loaded.");async function i(e,o){await chrome.scripting.executeScript({target:{tabId:e},files:[o]})}function r(e){chrome.runtime.sendMessage({action:"updateStatus",data:e})}chrome.runtime.onMessage.addListener((e,o,n)=>(e.action==="startScraping"?(console.log("Nhận được yêu cầu cào dữ liệu..."),l(),n({status:"Đã nhận lệnh, đang xử lý..."})):e.action==="downloadJson"&&(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải file."),chrome.storage.local.get("scrapedData",t=>{if(console.log("== DOWNLOAD FLOW: Dữ liệu lấy từ storage:",t),t&&t.scrapedData){const a=t.scrapedData,s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(a,null,2));console.log("== DOWNLOAD FLOW: Chuẩn bị tải xuống file.");try{chrome.downloads.download({url:s,filename:"fap_data.json",saveAs:!0},c=>{chrome.runtime.lastError?console.error("== DOWNLOAD FLOW: Lỗi khi tải file:",chrome.runtime.lastError):console.log("== DOWNLOAD FLOW: Tải file thành công, downloadId:",c)})}catch(c){console.error("== DOWNLOAD FLOW: Lỗi khi gọi chrome.downloads.download:",c)}}else console.error("== DOWNLOAD FLOW: Không tìm thấy 'scrapedData' trong storage.")})),!0));async function l(){try{const e="https://fap.fpt.edu.vn/Exam/ScheduleExams.aspx";r("Đang mở trang Lịch thi...");const o=await chrome.tabs.create({url:e,active:!1});o.id&&chrome.tabs.onUpdated.addListener(async function n(t,a){t===o.id&&a.status==="complete"&&(chrome.tabs.onUpdated.removeListener(n),r("Đang cào dữ liệu Lịch thi..."),await i(o.id,"content-scripts/fap-scraper.js"))})}catch(e){console.error("Lỗi trong quá trình cào dữ liệu:",e),r(`Đã xảy ra lỗi: ${e.message}`)}}chrome.runtime.onMessage.addListener((e,o,n)=>{if(e.action==="scrapedData"){const t=e.data;console.log("Đã nhận dữ liệu từ content script:",t),r("Đã nhận dữ liệu, đang lưu trữ...");const a={examSchedule:t};chrome.storage.local.set({scrapedData:a},()=>{console.log("== SAVE FLOW: Dữ liệu đã được LƯU THÀNH CÔNG vào storage."),chrome.runtime.sendMessage({action:"scrapingComplete"})})}});
