console.log("Background script loaded.");async function i(t,e){await chrome.scripting.executeScript({target:{tabId:t},files:[e]})}function n(t){chrome.runtime.sendMessage({action:"updateStatus",data:t})}function l(t,e){chrome.storage.local.get("scrapedData",a=>{if(console.log("== DOWNLOAD FLOW: Dữ liệu lấy từ storage:",a),a&&a.scrapedData){let r;switch(t){case"all":r=a.scrapedData;break;case"exam":r={examSchedule:a.scrapedData.examSchedule||[]};break;case"curriculum":r={curriculum:a.scrapedData.curriculum||{}};break;case"profile":r={profile:a.scrapedData.profile||{}};break;default:console.error("== DOWNLOAD FLOW: Loại tải không hợp lệ:",t);return}const o="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(r,null,2));console.log("== DOWNLOAD FLOW: Chuẩn bị tải xuống file:",e);try{chrome.downloads.download({url:o,filename:e,saveAs:!0},c=>{chrome.runtime.lastError?console.error("== DOWNLOAD FLOW: Lỗi khi tải file:",chrome.runtime.lastError):console.log("== DOWNLOAD FLOW: Tải file thành công, downloadId:",c)})}catch(c){console.error("== DOWNLOAD FLOW: Lỗi khi gọi chrome.downloads.download:",c)}}else console.error("== DOWNLOAD FLOW: Không tìm thấy 'scrapedData' trong storage.")})}chrome.runtime.onMessage.addListener((t,e,a)=>(t.action==="startScraping"?(console.log("Nhận được yêu cầu cào dữ liệu..."),p(),a({status:"Đã nhận lệnh, đang xử lý..."})):t.action==="downloadAll"?(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải tất cả dữ liệu."),l("all","fap_data_complete.json")):t.action==="downloadExam"?(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải dữ liệu lịch thi."),l("exam","fap_exam_schedule.json")):t.action==="downloadCurriculum"?(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải dữ liệu chương trình học."),l("curriculum","fap_curriculum.json")):t.action==="downloadProfile"?(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải dữ liệu profile."),l("profile","fap_profile.json")):t.action==="scrapeHTMLPage"?(console.log(`Nhận được yêu cầu cào HTML trang: ${t.pageType}`),L(t.pageType),a({status:"Đang mở trang để cào HTML..."})):t.action==="scrapeCurrentPage"&&(console.log("Nhận được yêu cầu cào HTML trang hiện tại"),D(),a({status:"Đang cào HTML trang hiện tại..."})),!0));async function p(){try{n("Bắt đầu cào dữ liệu..."),await g(),await m(),await f()}catch(t){console.error("Lỗi trong quá trình cào dữ liệu:",t),n(`Đã xảy ra lỗi: ${t.message}`)}}async function m(){try{const t="https://fap.fpt.edu.vn/Exam/ScheduleExams.aspx";n("Đang mở trang Lịch thi...");const e=await chrome.tabs.create({url:t,active:!1});e.id&&chrome.tabs.onUpdated.addListener(async function a(r,o){r===e.id&&o.status==="complete"&&(chrome.tabs.onUpdated.removeListener(a),n("Đang cào dữ liệu Lịch thi..."),await i(e.id,"content-scripts/fap-scraper.js"))})}catch(t){console.error("Lỗi trong quá trình cào dữ liệu lịch thi:",t),n(`Đã xảy ra lỗi: ${t.message}`)}}async function f(){try{const t="https://fap.fpt.edu.vn/FrontOffice/StudentCurriculum.aspx";n("Đang mở trang Chương trình học...");const e=await chrome.tabs.create({url:t,active:!1});e.id&&chrome.tabs.onUpdated.addListener(async function a(r,o){r===e.id&&o.status==="complete"&&(chrome.tabs.onUpdated.removeListener(a),n("Đang cào dữ liệu Chương trình học..."),await i(e.id,"content-scripts/fap-curriculum-scraper.js"))})}catch(t){console.error("Lỗi trong quá trình cào dữ liệu chương trình học:",t),n(`Đã xảy ra lỗi: ${t.message}`)}}async function g(){try{const t="https://fap.fpt.edu.vn/User/Profile.aspx";n("Đang mở trang Profile...");const e=await chrome.tabs.create({url:t,active:!1});e.id&&chrome.tabs.onUpdated.addListener(async function a(r,o){r===e.id&&o.status==="complete"&&(chrome.tabs.onUpdated.removeListener(a),n("Đang cào dữ liệu Profile..."),await i(e.id,"content-scripts/fap-profile-scraper.js"))})}catch(t){console.error("Lỗi trong quá trình cào dữ liệu profile:",t),n(`Đã xảy ra lỗi: ${t.message}`)}}let s=null,u=null,d=null;chrome.runtime.onMessage.addListener((t,e,a)=>{if(t.action==="scrapedData"){const r=t.data;console.log("Đã nhận dữ liệu lịch thi từ content script:",r),n("Đã nhận dữ liệu lịch thi..."),u=r,h()}else if(t.action==="scrapedCurriculumData"){const r=t.data;console.log("Đã nhận dữ liệu chương trình học từ content script:",r),n("Đã nhận dữ liệu chương trình học..."),d=r,h()}else if(t.action==="scrapedProfileData"){const r=t.data;console.log("Đã nhận dữ liệu profile từ content script:",r),n("Đã nhận dữ liệu profile..."),s=r,h()}else if(t.action==="scrapedHTMLData"){const r=t.data;console.log("Đã nhận dữ liệu HTML từ content script:",r.fileName),n("Đang tải file HTML..."),O(r.content,r.fileName)}});function h(){if(s&&u&&d){n("Đang lưu trữ tất cả dữ liệu...");const t={profile:s,examSchedule:u,curriculum:d};chrome.storage.local.set({scrapedData:t},()=>{console.log("== SAVE FLOW: Tất cả dữ liệu đã được LƯU THÀNH CÔNG vào storage."),s=null,u=null,d=null,chrome.runtime.sendMessage({action:"scrapingComplete"})})}}async function L(t){try{let e="";switch(t){case"weekly-schedule":e="https://fap.fpt.edu.vn/Report/ScheduleOfWeek.aspx";break;case"exam-schedule":e="https://fap.fpt.edu.vn/Exam/ScheduleExams.aspx";break;case"student-grades":e="https://fap.fpt.edu.vn/Grade/StudentGrade.aspx";break;case"attendance-report":e="https://fap.fpt.edu.vn/Report/ViewAttendstudent.aspx";break;default:throw new Error(`Loại trang không được hỗ trợ: ${t}`)}n(`Đang mở trang ${t}...`);const a=await chrome.tabs.create({url:e,active:!1});a.id&&chrome.tabs.onUpdated.addListener(async function r(o,c){o===a.id&&c.status==="complete"&&(chrome.tabs.onUpdated.removeListener(r),n(`Đang cào HTML từ ${t}...`),await i(a.id,"content-scripts/html-scraper.js"),setTimeout(async()=>{try{a.id&&await chrome.tabs.remove(a.id)}catch{console.log("Tab có thể đã được đóng trước đó")}},5e3))})}catch(e){console.error(`Lỗi trong quá trình cào HTML ${t}:`,e),n(`Lỗi: ${e.message}`),chrome.runtime.sendMessage({action:"htmlScrapingError",error:e.message})}}async function D(){try{const e=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0];if(!e||!e.id)throw new Error("Không thể tìm thấy tab hiện tại");if(!e.url||!e.url.includes("fap.fpt.edu.vn"))throw new Error("Tab hiện tại không phải là trang FAP");n("Đang cào HTML từ trang hiện tại..."),await i(e.id,"content-scripts/html-scraper.js")}catch(t){console.error("Lỗi trong quá trình cào HTML trang hiện tại:",t),n(`Lỗi: ${t.message}`),chrome.runtime.sendMessage({action:"htmlScrapingError",error:t.message})}}function O(t,e){const a="data:text/plain;charset=utf-8,"+encodeURIComponent(t);console.log("== HTML DOWNLOAD FLOW: Chuẩn bị tải xuống file HTML:",e);try{chrome.downloads.download({url:a,filename:e,saveAs:!0},r=>{chrome.runtime.lastError?(console.error("== HTML DOWNLOAD FLOW: Lỗi khi tải file:",chrome.runtime.lastError),chrome.runtime.sendMessage({action:"htmlScrapingError",error:chrome.runtime.lastError.message})):(console.log("== HTML DOWNLOAD FLOW: Tải file thành công, downloadId:",r),chrome.runtime.sendMessage({action:"htmlScrapingComplete",fileName:e}))})}catch(r){console.error("== HTML DOWNLOAD FLOW: Lỗi khi gọi chrome.downloads.download:",r),chrome.runtime.sendMessage({action:"htmlScrapingError",error:r.message})}}
