function e(n){return n?n.trim():""}function v(){const n=new Date().toISOString(),g=document.querySelector("#ctl00_mainContent_divTerm b"),f=g?e(g.textContent):"Unknown",h=document.querySelector("#ctl00_mainContent_divCourse b");let C="",d="";if(h){const u=e(h.textContent),r=u.match(/^(.*?)\(([^)]+)\)\s*\(.+\)$/);if(r)d=r[1].trim(),C=r[2].trim();else{const s=u.match(/^(.*?)\s*\(([^)]+)\)$/);s?(d=s[1].trim(),C=s[2].trim()):d=u}}const S=document.querySelector("#ctl00_mainContent_divGrade table");if(!S)throw new Error("Không tìm thấy bảng điểm");const l={subjectCode:C,subjectName:d,average:null,status:null,gradeDetails:[]},x=S.querySelector("tbody");if(x){const u=x.querySelectorAll("tr");let r="";for(const s of u){const t=s.querySelectorAll("td");if(t.length<2)continue;const c=t[0],i=t[1];if(c.hasAttribute("rowspan")){if(r=e(c.textContent),t.length>=4){const a=e(t[1].textContent),o=e(t[2].textContent).replace("%","").trim(),m=e(t[3].textContent);l.gradeDetails.push({category:r,item:a,weight:o?parseFloat(o):null,value:m?parseFloat(m):null})}}else if(e(c.textContent)===""&&e(i.textContent)==="Bonus"){if(t.length>=4){const a=e(t[3].textContent);l.gradeDetails.push({category:"Bonus",item:"Bonus",weight:null,value:a?parseFloat(a):null})}}else{const a=e(c.textContent);if(a.includes("Total"))continue;if(a.includes("Average")){const o=e(t[1]?.textContent);l.average=o?parseFloat(o):null;continue}if(a.includes("Status")){const o=t[1]?.querySelector("font");l.status=e(o?o.textContent:t[1]?.textContent);continue}if(t.length>=3){const o=e(t[1].textContent).replace("%","").trim(),m=e(t[2].textContent);l.gradeDetails.push({category:r,item:a,weight:o?parseFloat(o):null,value:m?parseFloat(m):null})}}}}const p=S.querySelector("tfoot");if(p){const u=p.querySelectorAll("tr");for(const r of u){const s=r.querySelectorAll("td");if(s.length<2)continue;const t=e(s[0].textContent),c=s[1];if(t.includes("Average")){const i=e(c.textContent);l.average=i?parseFloat(i):null}else if(t.includes("Status")){const i=c.querySelector("font");l.status=e(i?i.textContent:c.textContent)}}}const y={lastUpdated:n,semesters:[{term:f,courses:[l]}]};return console.log("Grade JSON Scraper: Đã cào dữ liệu điểm thành công",y),y}try{const n=v(),f=`fap-grade-${n.semesters[0]?.courses[0]?.subjectCode.replace(/[^a-zA-Z0-9]/g,"")||"unknown"}-${new Date().toISOString().replace(/[:.]/g,"-")}.json`;chrome.runtime.sendMessage({action:"scrapedGradeJSON",data:{content:JSON.stringify(n,null,2),fileName:f,gradeData:n}})}catch(n){console.error("Grade JSON Scraper: Lỗi khi cào dữ liệu",n),chrome.runtime.sendMessage({action:"gradeJSONScrapingError",error:n instanceof Error?n.message:"Unknown error"})}
