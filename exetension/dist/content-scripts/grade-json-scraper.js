function n(t){return t?t.trim():""}function y(){const t=new Date().toISOString(),l=document.querySelector("#ctl00_mainContent_divTerm b"),w=l?n(l.textContent):"Unknown",h=document.querySelector("#ctl00_mainContent_divCourse b");let C="",u="";if(h){const o=n(h.textContent),i=o.match(/^(.*?)\s*\(([^)]+)\)$/);i?(u=i[1].trim(),C=i[2].trim()):u=o}const S=document.querySelector("#ctl00_mainContent_divGrade table");if(!S)throw new Error("Không tìm thấy bảng điểm");const a={subjectCode:C,subjectName:u,average:null,status:null,gradeDetails:[]},f=S.querySelectorAll("tr");let m="";for(let o=1;o<f.length;o++){const e=f[o].querySelectorAll("td");if(e.length===0)continue;const x=e[0];if(x.hasAttribute("rowspan")){if(m=n(x.textContent),e.length>=4){const s=n(e[1].textContent),r=n(e[2].textContent).replace("%","").trim(),c=n(e[3].textContent),g=r?parseFloat(r):null,d=c?parseFloat(c):null;a.gradeDetails.push({category:m,item:s,weight:g,value:d})}}else{const s=n(e[0].textContent);if(s.includes("Total"))continue;if(s.includes("Average")){const r=n(e[1].textContent);a.average=r?parseFloat(r):null;continue}if(s.includes("Status")){const r=e[1].querySelector("font");a.status=n(r?r.textContent:e[1].textContent);continue}if(e.length>=3){const r=n(e[1].textContent).replace("%","").trim(),c=n(e[2].textContent),g=r?parseFloat(r):null,d=c?parseFloat(c):null;a.gradeDetails.push({category:m,item:s,weight:g,value:d})}}}const p={lastUpdated:t,semesters:[{term:w,courses:[a]}]};return console.log("Grade JSON Scraper: Đã cào dữ liệu điểm thành công",p),p}try{const t=y(),l=`fap-grade-${t.semesters[0].courses[0].subjectCode}-${new Date().toISOString().replace(/[:.]/g,"-")}.json`;chrome.runtime.sendMessage({action:"scrapedGradeJSON",data:{content:JSON.stringify(t,null,2),fileName:l,gradeData:t}})}catch(t){console.error("Grade JSON Scraper: Lỗi khi cào dữ liệu",t),chrome.runtime.sendMessage({action:"gradeJSONScrapingError",error:t instanceof Error?t.message:"Unknown error"})}
