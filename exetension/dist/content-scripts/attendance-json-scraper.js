function a(t){return t?t.trim():""}function D(t){const e=t.trim().split(" ");if(e.length<2)return{date:null,dayOfWeek:null};const l=e[0],d=e[1];try{const[o,s,u]=d.split("/");return{date:`${u}-${s.padStart(2,"0")}-${o.padStart(2,"0")}`,dayOfWeek:l}}catch{return{date:null,dayOfWeek:l}}}function O(t){const e=t.match(/(\d+)_?\((\d{1,2}:\d{2}-\d{1,2}:\d{2})\)/);return e?{slot:parseInt(e[1]),time:e[2]}:{slot:null,time:null}}function N(t){const e=t.match(/([\d\.]+)% absent so far \((\d+) absent on (\d+) total\)/);return e?{absentPercentage:parseFloat(e[1]),absentSlots:parseInt(e[2]),totalSlots:parseInt(e[3])}:{absentPercentage:0,absentSlots:0,totalSlots:0}}function w(){const t=new Date().toISOString(),e=document.querySelector("#ctl00_mainContent_divTerm b"),l=e?a(e.textContent):"Unknown",d=document.querySelector("#ctl00_mainContent_divCourse b");let o="",s="",u="";if(d){const r=a(d.textContent),n=r.match(/(.+?)\((.+?)\)\((.+?),start/);n?(s=n[1].trim(),o=n[2].trim(),u=n[3].trim()):s=r}const m=document.querySelector(".table.table-bordered.table1");if(!m)throw new Error("Không tìm thấy bảng điểm danh");const c={subjectCode:o,subjectName:s,groupName:u,absentPercentage:0,absentSlots:0,totalSlots:0,attendanceDetails:[]},p=m.querySelectorAll("tbody tr");for(const r of p){const n=r.querySelectorAll("td");if(n.length<7)continue;const h=parseInt(a(n[0].textContent))||0,{date:f,dayOfWeek:b}=D(a(n[1].textContent)),{slot:g,time:y}=O(a(n[2].textContent)),C=a(n[6].textContent);f&&b&&c.attendanceDetails.push({no:h,date:f,dayOfWeek:b,slot:g,time:y,status:C})}const i=m.querySelector("tfoot");if(i){const r=N(a(i.textContent));c.absentPercentage=r.absentPercentage,c.absentSlots=r.absentSlots,c.totalSlots=r.totalSlots}const S={lastUpdated:t,semesters:[{term:l,courses:[c]}]};return console.log("Attendance JSON Scraper: Đã cào dữ liệu điểm danh thành công",S),S}try{const t=w(),e=`fap-attendance-${t.semesters[0].courses[0].subjectCode}-${new Date().toISOString().replace(/[:.]/g,"-")}.json`;chrome.runtime.sendMessage({action:"scrapedAttendanceJSON",data:{content:JSON.stringify(t,null,2),fileName:e,attendanceData:t}})}catch(t){console.error("Attendance JSON Scraper: Lỗi khi cào dữ liệu",t),chrome.runtime.sendMessage({action:"attendanceJSONScrapingError",error:t instanceof Error?t.message:"Unknown error"})}
