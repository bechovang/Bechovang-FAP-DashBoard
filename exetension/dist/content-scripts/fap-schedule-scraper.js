function x(){if(console.log("FAP Schedule Scraper: Bắt đầu cào dữ liệu lịch học."),document.readyState!=="complete")return console.log("Page not fully loaded, waiting..."),setTimeout(()=>x(),1e3),null;const r=(l,e=document)=>{const t=e.querySelector(l);return t?t.innerText.trim():""},F=(l,e)=>{if(console.log(`Parsing slot ${e}, cell content:`,l.innerHTML),l.innerText.trim()==="-")return console.log(`Slot ${e}: Empty cell (-)`),null;const t=l.querySelector("p");if(!t)return console.log(`Slot ${e}: No paragraph found`),null;const o=t.querySelector("a");if(!o)return console.log(`Slot ${e}: No main link found`),null;const h=o.innerHTML;console.log(`Slot ${e} main link HTML:`,h);const n=(o.textContent?.split("-")[0]||"").trim()||null;console.log(`Slot ${e} subject code:`,n);const a=(o.querySelector("a")||t.querySelector('a[href*="ListScheduleSyllabus"]'))?.getAttribute("href")||null;console.log(`Slot ${e} materials URL:`,a);let c=r("span.label-success",t)||null;if(!c){const u=t.innerHTML.match(/\((\d{2}:\d{2}-\d{2}:\d{2})\)/);c=u?u[1]:null}c&&c.startsWith("(")&&c.endsWith(")")&&(c=c.slice(1,-1)),console.log(`Slot ${e} time:`,c);let s=r("font",t)||null;if(!s){const u=t.innerHTML.match(/\((attended|Not yet|absent)\)/i);s=u?u[1]:null}s&&(s=s.charAt(0).toUpperCase()+s.slice(1)),console.log(`Slot ${e} attendance:`,s);let f=null;const A=t.innerHTML.match(/at\s+([^<(]+)/i);A&&(f=A[1].trim().replace(/\s+/g," ")),console.log(`Slot ${e} room:`,f);const C={slot:e,time:c,subjectCode:n,room:f,lecturer:null,attendanceStatus:s,materialsUrl:a};return console.log("Parsed activity:",C),C},$=document.querySelector("#ctl00_mainContent_drpYear option:checked"),b=$?parseInt($.innerText,10):new Date().getFullYear(),y=document.querySelector("#ctl00_mainContent_drpSelectWeek option:checked");if(!y)return console.error("Không tìm thấy thông tin tuần."),null;const M=parseInt(y.value,10),L=y.innerText.trim();console.log("Year:",b,"Week:",M,"Label:",L);const k=document.querySelectorAll("th");console.log(`Total th elements found: ${k.length}`);let d=[],g=[];if(k.forEach((l,e)=>{const t=l.textContent?.trim()||"";console.log(`TH[${e}]: "${t}"`),["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].includes(t)&&d.push(t),/^\d{2}\/\d{2}$/.test(t)&&g.push(t)}),console.log("Found day names:",d),console.log("Found day dates:",g),d.length===0||g.length===0)return console.error("CRITICAL ERROR: Không tìm thấy thông tin ngày/thứ trong tuần."),null;const R={Mon:"Monday",Tue:"Tuesday",Wed:"Wednesday",Thu:"Thursday",Fri:"Friday",Sat:"Saturday",Sun:"Sunday"},i=d.map((l,e)=>({day:R[l]||l,date:g[e]||"",activities:[]})),S=document.querySelectorAll("table");console.log(`Found ${S.length} tables`);let T=null;for(let l=0;l<S.length;l++){const e=S[l],t=e.querySelectorAll("tr"),o=e.innerHTML.includes("Mon")&&e.innerHTML.includes("Tue");if(console.log(`Table[${l}]: ${t.length} rows, hasTimeHeaders: ${o}`),t.length>=8&&o){T=e,console.log(`Selected table[${l}] as schedule table`);break}}if(!T)return console.error("Không tìm thấy bảng lịch học."),null;const H=T.querySelectorAll("tr");console.log(`Schedule table has ${H.length} rows`);const q=Array.from(H).slice(2);console.log(`Processing ${q.length} data rows`),q.forEach((l,e)=>{const t=l.querySelectorAll("td");if(console.log(`Row ${e}: found ${t.length} cells`),t.length<8){console.log(`Row ${e}: skipping - not enough cells`);return}const o=t[0].textContent?.trim()||"",h=o.match(/Slot\s+(\d+)/i),p=h?parseInt(h[1],10):e+1;console.log(`Processing row ${e}, slot ${p}, slotText: "${o}"`);for(let n=0;n<7&&n<i.length;n++){const m=t[n+1];if(m){console.log(`Day ${n} (${i[n].day}) cell content:`,m.innerHTML.substring(0,100));const a=F(m,p);a&&(i[n].activities.push(a),console.log(`✓ Added activity to day ${n} (${i[n].day}):`,a))}}});const w={lastUpdated:new Date().toISOString(),schedule:[{year:b,weekNumber:M,weekLabel:L,days:i}]};return console.log("Final schedule data:",w),w}setTimeout(()=>{console.log("Starting schedule scraping...");const r=x();r?(console.log("Schedule data successfully scraped, sending to background..."),chrome.runtime.sendMessage({action:"scrapedScheduleData",data:r})):console.error("Failed to scrape schedule data")},2e3);
