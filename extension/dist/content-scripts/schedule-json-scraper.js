function _(){const e=new Date().toISOString(),c=document.querySelector("#ctl00_mainContent_drpYear"),d=document.querySelector("#ctl00_mainContent_drpSelectWeek");let S=2025,m=1,g="";c?.selectedOptions[0]&&(S=parseInt(c.selectedOptions[0].value)),d?.selectedOptions[0]&&(m=parseInt(d.selectedOptions[0].value),g=d.selectedOptions[0].text);const f=document.querySelectorAll("table"),u=f[f.length-2];if(!u)throw new Error("Không tìm thấy bảng lịch học. Selector có thể đã thay đổi.");const p={year:S,weekNumber:m,weekLabel:g,days:[]},v={Mon:"Monday",Tue:"Tuesday",Wed:"Wednesday",Thu:"Thursday",Fri:"Friday",Sat:"Saturday",Sun:"Sunday"},b=u.querySelector("thead");if(!b)throw new Error("Không tìm thấy thead trong bảng lịch học.");const h=b.querySelectorAll("tr");if(h.length<2)throw new Error("Cấu trúc a eader của bảng không hợp lệ");const w=h[0].querySelectorAll("th"),D=h[1].querySelectorAll("th"),l=[];for(let t=1;t<w.length;t++){const n=w[t].textContent?.trim()||"",a=v[n]||n,s=D[t-1]?.textContent?.trim()||"";l.push({day:a,date:s,activities:[]})}const q=u.querySelector("tbody");if(!q)throw new Error("Không tìm thấy tbody trong bảng lịch học.");const E=q.querySelectorAll("tr");for(const t of E){const n=t.querySelectorAll("td");if(n.length===0)continue;const a=n[0].textContent?.trim()||"";if(!a.startsWith("Slot"))continue;const s=parseInt(a.replace("Slot ",""));if(!isNaN(s))for(let i=0;i<l.length;i++){const N=n[i+1];if(!N)continue;const r=N.querySelector("p");if(!r)continue;const T=r.querySelector('a[href*="ActivityDetail.aspx"]'),I=r.querySelector("a.label-warning"),C=r.querySelector("span.label-success"),O=r.querySelector("font");if(T&&C){const J=T.textContent?.replace("-","").trim()||"",M=C.textContent?.replace(/[()]/g,"").trim()||"";let A=null;const k=r.querySelector("br");if(k?.nextSibling?.textContent){const o=k.nextSibling.textContent.trim();o.startsWith("at ")&&(A=o.substring(3).trim())}let y="Not yet";if(O){const o=O.textContent?.trim()||"";o==="attended"?y="Attended":o==="absent"&&(y="Absent")}const W=I?.getAttribute("href")||null,j={slot:s,time:M,subjectCode:J,room:A,lecturer:null,attendanceStatus:y,materialsUrl:W};l[i].activities.push(j)}}}p.days=l;const x={lastUpdated:e,schedule:[p]};return console.log("Schedule JSON Scraper: Đã cào dữ liệu lịch học thành công",x),x}try{const e=_();if(typeof chrome<"u"&&chrome.runtime){const c=`fap-schedule-json-${new Date().toISOString().replace(/[:.]/g,"-")}.json`;chrome.runtime.sendMessage({action:"scrapedScheduleJSON",data:{content:JSON.stringify(e,null,2),fileName:c,scheduleData:e}})}}catch(e){console.error("Schedule JSON Scraper: Lỗi khi cào dữ liệu",e),typeof chrome<"u"&&chrome.runtime&&chrome.runtime.sendMessage({action:"scheduleJSONScrapingError",error:e instanceof Error?e.message:"Unknown error"})}
