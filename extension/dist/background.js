console.log("Background script loaded.");async function l(e,r){await chrome.scripting.executeScript({target:{tabId:e},files:[r]})}function n(e){chrome.runtime.sendMessage({action:"updateStatus",data:e})}function m(e,r){chrome.storage.local.get("scrapedData",a=>{if(console.log("== DOWNLOAD FLOW: Dữ liệu lấy từ storage:",a),a&&a.scrapedData){let t;switch(e){case"all":t=a.scrapedData;break;case"exam":t={examSchedule:a.scrapedData.examSchedule||[]};break;case"curriculum":t={curriculum:a.scrapedData.curriculum||{}};break;case"profile":t={profile:a.scrapedData.profile||{}};break;default:console.error("== DOWNLOAD FLOW: Loại tải không hợp lệ:",e);return}const c="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t,null,2));console.log("== DOWNLOAD FLOW: Chuẩn bị tải xuống file:",r);try{chrome.downloads.download({url:c,filename:r,saveAs:!1},o=>{chrome.runtime.lastError?console.error("== DOWNLOAD FLOW: Lỗi khi tải file:",chrome.runtime.lastError):console.log("== DOWNLOAD FLOW: Tải file thành công, downloadId:",o)})}catch(o){console.error("== DOWNLOAD FLOW: Lỗi khi gọi chrome.downloads.download:",o)}}else console.error("== DOWNLOAD FLOW: Không tìm thấy 'scrapedData' trong storage.")})}chrome.runtime.onMessage.addListener((e,r,a)=>(e.action==="startScraping"?(console.log("Nhận được yêu cầu cào dữ liệu..."),J(),a({status:"Đã nhận lệnh, đang xử lý..."})):e.action==="downloadAll"?(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải tất cả dữ liệu."),m("all","fap_data_complete.json")):e.action==="downloadExam"?(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải dữ liệu lịch thi."),m("exam","fap_exam_schedule.json")):e.action==="downloadCurriculum"?(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải dữ liệu chương trình học."),m("curriculum","fap_curriculum.json")):e.action==="downloadProfile"?(console.log("== DOWNLOAD FLOW: Nhận được yêu cầu tải dữ liệu profile."),m("profile","fap_profile.json")):e.action==="scrapeHTMLPage"?(console.log(`Nhận được yêu cầu cào HTML trang: ${e.pageType}`),E(e.pageType),a({status:"Đang mở trang để cào HTML..."})):e.action==="scrapeCurrentPage"?(console.log("Nhận được yêu cầu cào HTML trang hiện tại"),k(),a({status:"Đang cào HTML trang hiện tại..."})):e.action==="scrapeScheduleJSON"?(console.log("Nhận được yêu cầu cào JSON lịch học tuần"),F(),a({status:"Đang mở trang lịch tuần để cào JSON..."})):e.action==="scrapeGradeJSON"?(console.log("Nhận được yêu cầu cào JSON điểm từ các link:",e.urls),P(e.urls),a({status:"Đang bắt đầu cào điểm từ các môn học..."})):e.action==="scrapeAttendanceJSON"&&(console.log("Nhận được yêu cầu cào JSON điểm danh từ các link:",e.urls),$(e.urls),a({status:"Đang bắt đầu cào điểm danh từ các môn học..."})),!0));async function J(){try{n("Bắt đầu cào dữ liệu..."),await A(),await x(),await U()}catch(e){console.error("Lỗi trong quá trình cào dữ liệu:",e),n(`Đã xảy ra lỗi: ${e.message}`)}}async function x(){try{const e="https://fap.fpt.edu.vn/Exam/ScheduleExams.aspx";n("Đang mở trang Lịch thi...");const r=await chrome.tabs.create({url:e,active:!1});r.id&&chrome.tabs.onUpdated.addListener(async function a(t,c){t===r.id&&c.status==="complete"&&(chrome.tabs.onUpdated.removeListener(a),n("Đang cào dữ liệu Lịch thi..."),await l(r.id,"content-scripts/fap-scraper.js"))})}catch(e){console.error("Lỗi trong quá trình cào dữ liệu lịch thi:",e),n(`Đã xảy ra lỗi: ${e.message}`)}}async function U(){try{const e="https://fap.fpt.edu.vn/FrontOffice/StudentCurriculum.aspx";n("Đang mở trang Chương trình học...");const r=await chrome.tabs.create({url:e,active:!1});r.id&&chrome.tabs.onUpdated.addListener(async function a(t,c){t===r.id&&c.status==="complete"&&(chrome.tabs.onUpdated.removeListener(a),n("Đang cào dữ liệu Chương trình học..."),await l(r.id,"content-scripts/fap-curriculum-scraper.js"))})}catch(e){console.error("Lỗi trong quá trình cào dữ liệu chương trình học:",e),n(`Đã xảy ra lỗi: ${e.message}`)}}async function A(){try{const e="https://fap.fpt.edu.vn/User/Profile.aspx";n("Đang mở trang Profile...");const r=await chrome.tabs.create({url:e,active:!1});r.id&&chrome.tabs.onUpdated.addListener(async function a(t,c){t===r.id&&c.status==="complete"&&(chrome.tabs.onUpdated.removeListener(a),n("Đang cào dữ liệu Profile..."),await l(r.id,"content-scripts/fap-profile-scraper.js"))})}catch(e){console.error("Lỗi trong quá trình cào dữ liệu profile:",e),n(`Đã xảy ra lỗi: ${e.message}`)}}let p=null,g=null,f=null;chrome.runtime.onMessage.addListener((e,r,a)=>{if(e.action==="scrapedData"){const t=e.data;console.log("Đã nhận dữ liệu lịch thi từ content script:",t),n("Đã nhận dữ liệu lịch thi..."),g=t,b()}else if(e.action==="scrapedCurriculumData"){const t=e.data;console.log("Đã nhận dữ liệu chương trình học từ content script:",t),n("Đã nhận dữ liệu chương trình học..."),f=t,b()}else if(e.action==="scrapedProfileData"){const t=e.data;console.log("Đã nhận dữ liệu profile từ content script:",t),n("Đã nhận dữ liệu profile..."),p=t,b()}else if(e.action==="scrapedHTMLData"){const t=e.data;console.log("Đã nhận dữ liệu HTML từ content script:",t.fileName),n("Đang tải file HTML..."),H(t.content,t.fileName)}else if(e.action==="scrapedScheduleJSON"){const t=e.data;console.log("Đã nhận dữ liệu JSON lịch học từ content script:",t.fileName),n("Đang tải file JSON lịch học..."),M(t.content,t.fileName)}else if(e.action==="scrapedGradeJSON"){const t=e.data;if(console.log("Đã nhận dữ liệu JSON điểm từ content script:",t.fileName),t.gradeData&&t.gradeData.semesters)for(const c of t.gradeData.semesters){let o=T.get(c.term);o||(o={term:c.term,courses:[]},T.set(c.term,o),y.semesters.push(o));for(const i of c.courses)o.courses.push(i)}O=!0,n("Đã thu thập dữ liệu điểm, đang tiếp tục...")}else if(e.action==="scrapedAttendanceJSON"){const t=e.data;if(console.log("Đã nhận dữ liệu JSON điểm danh từ content script:",t.fileName),t.attendanceData&&t.attendanceData.semesters)for(const c of t.attendanceData.semesters){let o=v.get(c.term);o||(o={term:c.term,courses:[]},v.set(c.term,o),W.semesters.push(o));for(const i of c.courses)o.courses.push(i)}L=!0,n("Đã thu thập dữ liệu điểm danh, đang tiếp tục...")}});function b(){if(p&&g&&f){n("Đang lưu trữ tất cả dữ liệu...");const e={profile:p,examSchedule:g,curriculum:f};chrome.storage.local.set({scrapedData:e},()=>{console.log("== SAVE FLOW: Tất cả dữ liệu đã được LƯU THÀNH CÔNG vào storage."),p=null,g=null,f=null,chrome.runtime.sendMessage({action:"scrapingComplete"})})}}async function E(e){try{let r="";switch(e){case"weekly-schedule":r="https://fap.fpt.edu.vn/Report/ScheduleOfWeek.aspx";break;case"exam-schedule":r="https://fap.fpt.edu.vn/Exam/ScheduleExams.aspx";break;case"student-grades":r="https://fap.fpt.edu.vn/Grade/StudentGrade.aspx";break;case"attendance-report":r="https://fap.fpt.edu.vn/Report/ViewAttendstudent.aspx";break;default:throw new Error(`Loại trang không được hỗ trợ: ${e}`)}n(`Đang mở trang ${e}...`);const a=await chrome.tabs.create({url:r,active:!1});a.id&&chrome.tabs.onUpdated.addListener(async function t(c,o){c===a.id&&o.status==="complete"&&(chrome.tabs.onUpdated.removeListener(t),n(`Đang cào HTML từ ${e}...`),await l(a.id,"content-scripts/html-scraper.js"),setTimeout(async()=>{try{a.id&&await chrome.tabs.remove(a.id)}catch{console.log("Tab có thể đã được đóng trước đó")}},5e3))})}catch(r){console.error(`Lỗi trong quá trình cào HTML ${e}:`,r),n(`Lỗi: ${r.message}`),chrome.runtime.sendMessage({action:"htmlScrapingError",error:r.message})}}async function k(){try{const r=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0];if(!r||!r.id)throw new Error("Không thể tìm thấy tab hiện tại");if(!r.url||!r.url.includes("fap.fpt.edu.vn"))throw new Error("Tab hiện tại không phải là trang FAP");n("Đang cào HTML từ trang hiện tại..."),await l(r.id,"content-scripts/html-scraper.js")}catch(e){console.error("Lỗi trong quá trình cào HTML trang hiện tại:",e),n(`Lỗi: ${e.message}`),chrome.runtime.sendMessage({action:"htmlScrapingError",error:e.message})}}function H(e,r){const a="data:text/plain;charset=utf-8,"+encodeURIComponent(e);console.log("== HTML DOWNLOAD FLOW: Chuẩn bị tải xuống file HTML:",r);try{chrome.downloads.download({url:a,filename:r,saveAs:!1},t=>{chrome.runtime.lastError?(console.error("== HTML DOWNLOAD FLOW: Lỗi khi tải file:",chrome.runtime.lastError),chrome.runtime.sendMessage({action:"htmlScrapingError",error:chrome.runtime.lastError.message})):(console.log("== HTML DOWNLOAD FLOW: Tải file thành công, downloadId:",t),chrome.runtime.sendMessage({action:"htmlScrapingComplete",fileName:r}))})}catch(t){console.error("== HTML DOWNLOAD FLOW: Lỗi khi gọi chrome.downloads.download:",t),chrome.runtime.sendMessage({action:"htmlScrapingError",error:t.message})}}function M(e,r){const a="data:application/json;charset=utf-8,"+encodeURIComponent(e);console.log("== JSON DOWNLOAD FLOW: Chuẩn bị tải xuống file JSON:",r);try{chrome.downloads.download({url:a,filename:r,saveAs:!1},t=>{chrome.runtime.lastError?(console.error("== JSON DOWNLOAD FLOW: Lỗi khi tải file:",chrome.runtime.lastError),chrome.runtime.sendMessage({action:"scheduleJSONScrapingError",error:chrome.runtime.lastError.message})):(console.log("== JSON DOWNLOAD FLOW: Tải file thành công, downloadId:",t),chrome.runtime.sendMessage({action:"scheduleJSONScrapingComplete",fileName:r}))})}catch(t){console.error("== JSON DOWNLOAD FLOW: Lỗi khi gọi chrome.downloads.download:",t),chrome.runtime.sendMessage({action:"scheduleJSONScrapingError",error:t.message})}}async function F(){try{const e="https://fap.fpt.edu.vn/Report/ScheduleOfWeek.aspx";n("Đang mở trang lịch học tuần...");const r=await chrome.tabs.create({url:e,active:!1});r.id&&chrome.tabs.onUpdated.addListener(async function a(t,c){t===r.id&&c.status==="complete"&&(chrome.tabs.onUpdated.removeListener(a),n("Đang cào JSON lịch học tuần..."),await l(r.id,"content-scripts/schedule-json-scraper.js"),setTimeout(async()=>{try{r.id&&await chrome.tabs.remove(r.id)}catch{console.log("Tab có thể đã được đóng trước đó")}},5e3))})}catch(e){console.error("Lỗi trong quá trình cào JSON lịch học tuần:",e),n(`Lỗi: ${e.message}`),chrome.runtime.sendMessage({action:"scheduleJSONScrapingError",error:e.message})}}let y={lastUpdated:new Date().toISOString(),semesters:[]};const T=new Map;let O=!1,W={lastUpdated:new Date().toISOString(),semesters:[]};const v=new Map;let L=!1;async function P(e){try{y={lastUpdated:new Date().toISOString(),semesters:[]},T.clear(),O=!1,n(`Đang cào điểm từ ${e.length} môn học...`);for(let t=0;t<e.length;t++){const c=e[t];chrome.runtime.sendMessage({action:"gradeJSONScrapingProgress",current:t+1,total:e.length});try{const o=await chrome.tabs.create({url:c,active:!1});if(o.id){await new Promise((s,u)=>{const w=setTimeout(()=>{chrome.tabs.onUpdated.removeListener(d),u(new Error("Timeout waiting for page to load"))},3e4),d=async(D,N)=>{if(D===o.id&&N.status==="complete"){clearTimeout(w),chrome.tabs.onUpdated.removeListener(d);try{await l(o.id,"content-scripts/grade-json-scraper.js"),await new Promise(h=>setTimeout(h,3e3)),s()}catch(h){u(h)}}};chrome.tabs.onUpdated.addListener(d)});let i=0;const S=1e4;for(;!O&&i<S;)await new Promise(s=>setTimeout(s,500)),i+=500;O=!1;try{await chrome.tabs.remove(o.id)}catch(s){console.log("Tab có thể đã được đóng trước đó:",s)}await new Promise(s=>setTimeout(s,1e3))}}catch(o){console.error(`Lỗi khi cào điểm từ URL ${c}:`,o)}}const r=`fap-grades-combined-${new Date().toISOString().replace(/[:.]/g,"-")}.json`,a=JSON.stringify(y,null,2);M(a,r),chrome.runtime.sendMessage({action:"gradeJSONScrapingComplete",fileName:r}),n(`Đã hoàn thành cào điểm từ ${e.length} môn học và tạo file tổng hợp!`)}catch(r){console.error("Lỗi trong quá trình cào JSON điểm:",r),n(`Lỗi: ${r.message}`),chrome.runtime.sendMessage({action:"gradeJSONScrapingError",error:r.message})}}async function $(e){try{W={lastUpdated:new Date().toISOString(),semesters:[]},v.clear(),L=!1,n(`Đang cào điểm danh từ ${e.length} môn học...`);for(let t=0;t<e.length;t++){const c=e[t];chrome.runtime.sendMessage({action:"attendanceJSONScrapingProgress",current:t+1,total:e.length});try{const o=await chrome.tabs.create({url:c,active:!1});if(o.id){await new Promise((s,u)=>{const w=setTimeout(()=>{chrome.tabs.onUpdated.removeListener(d),u(new Error("Timeout waiting for page to load"))},3e4),d=async(D,N)=>{if(D===o.id&&N.status==="complete"){clearTimeout(w),chrome.tabs.onUpdated.removeListener(d);try{await l(o.id,"content-scripts/attendance-json-scraper.js"),await new Promise(h=>setTimeout(h,3e3)),s()}catch(h){u(h)}}};chrome.tabs.onUpdated.addListener(d)});let i=0;const S=1e4;for(;!L&&i<S;)await new Promise(s=>setTimeout(s,500)),i+=500;L=!1;try{await chrome.tabs.remove(o.id)}catch(s){console.log("Tab có thể đã được đóng trước đó:",s)}await new Promise(s=>setTimeout(s,1e3))}}catch(o){console.error(`Lỗi khi cào điểm danh từ URL ${c}:`,o)}}const r=`fap-attendance-combined-${new Date().toISOString().replace(/[:.]/g,"-")}.json`,a=JSON.stringify(W,null,2);M(a,r),chrome.runtime.sendMessage({action:"attendanceJSONScrapingComplete",fileName:r}),n(`Đã hoàn thành cào điểm danh từ ${e.length} môn học và tạo file tổng hợp!`)}catch(r){console.error("Lỗi trong quá trình cào JSON điểm danh:",r),n(`Lỗi: ${r.message}`),chrome.runtime.sendMessage({action:"attendanceJSONScrapingError",error:r.message})}}chrome.runtime.onInstalled.addListener(async()=>{const e={autoScrapeEnabled:!1,autoUploadEnabled:!1,uploadTargetUrl:"https://v0-web-app-logic.vercel.app/upload",runIntervals:{phase1Hours:12,phase2Hours:24,phase3Hours:24},gradeUrls:[],attendanceUrls:[]},r=await chrome.storage.sync.get(Object.keys(e)),a={};for(const t of Object.keys(e))r[t]===void 0&&(a[t]=e[t]);Object.keys(a).length&&await chrome.storage.sync.set(a)});
