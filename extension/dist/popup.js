(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))y(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&y(s)}).observe(document,{childList:!0,subtree:!0});function c(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function y(n){if(n.ep)return;n.ep=!0;const r=c(n);fetch(n.href,r)}})();const l=document.getElementById("scrapeBtn"),f=document.getElementById("downloadAllBtn"),E=document.getElementById("downloadProfileBtn"),B=document.getElementById("downloadExamBtn"),S=document.getElementById("downloadCurriculumBtn"),I=document.getElementById("scrapeWeeklyScheduleBtn"),x=document.getElementById("scrapeExamScheduleBtn"),L=document.getElementById("scrapeGradesBtn"),N=document.getElementById("scrapeAttendanceBtn"),b=document.getElementById("scrapeCurrentPageBtn"),O=document.getElementById("scrapeScheduleJSONBtn"),J=document.getElementById("scrapeGradeJSONBtn"),U=document.getElementById("gradeUrlsInput"),M=document.getElementById("scrapeAttendanceJSONBtn"),k=document.getElementById("attendanceUrlsInput"),t=document.getElementById("status");chrome.storage.local.get("scrapedData",e=>{e&&e.scrapedData&&(f.disabled=!1,E.disabled=!1,B.disabled=!1,S.disabled=!1,t.textContent="Dữ liệu đã sẵn sàng để tải.")});l.addEventListener("click",()=>{l.disabled=!0,t.textContent="Đang bắt đầu...",chrome.runtime.sendMessage({action:"startScraping"},e=>{chrome.runtime.lastError?(t.textContent=`Lỗi: ${chrome.runtime.lastError.message}`,l.disabled=!1):e&&e.status&&(t.textContent=e.status)})});f.addEventListener("click",()=>{chrome.runtime.sendMessage({action:"downloadAll"})});E.addEventListener("click",()=>{chrome.runtime.sendMessage({action:"downloadProfile"})});B.addEventListener("click",()=>{chrome.runtime.sendMessage({action:"downloadExam"})});S.addEventListener("click",()=>{chrome.runtime.sendMessage({action:"downloadCurriculum"})});I?.addEventListener("click",()=>{t.textContent="Đang mở trang lịch tuần...",chrome.runtime.sendMessage({action:"scrapeHTMLPage",pageType:"weekly-schedule"})});x?.addEventListener("click",()=>{t.textContent="Đang mở trang lịch thi...",chrome.runtime.sendMessage({action:"scrapeHTMLPage",pageType:"exam-schedule"})});L?.addEventListener("click",()=>{t.textContent="Đang mở trang điểm...",chrome.runtime.sendMessage({action:"scrapeHTMLPage",pageType:"student-grades"})});N?.addEventListener("click",()=>{t.textContent="Đang mở trang điểm danh...",chrome.runtime.sendMessage({action:"scrapeHTMLPage",pageType:"attendance-report"})});b?.addEventListener("click",()=>{t.textContent="Đang cào trang hiện tại...",chrome.runtime.sendMessage({action:"scrapeCurrentPage"})});O.addEventListener("click",()=>{t.textContent="Đang mở trang lịch tuần để cào JSON...",chrome.runtime.sendMessage({action:"scrapeScheduleJSON"})});J.addEventListener("click",()=>{const e=U.value.trim().split(`
`).filter(a=>a.trim()!=="");if(e.length===0){t.textContent="Vui lòng nhập ít nhất một link môn học!";return}t.textContent=`Đang cào điểm từ ${e.length} môn học...`,chrome.runtime.sendMessage({action:"scrapeGradeJSON",urls:e})});M.addEventListener("click",()=>{const e=k.value.trim().split(`
`).filter(a=>a.trim()!=="");if(e.length===0){t.textContent="Vui lòng nhập ít nhất một link điểm danh!";return}t.textContent=`Đang cào điểm danh từ ${e.length} môn học...`,chrome.runtime.sendMessage({action:"scrapeAttendanceJSON",urls:e})});chrome.runtime.onMessage.addListener((e,a,c)=>{e.action==="updateStatus"?t.textContent=e.data:e.action==="scrapingComplete"?(t.textContent="Đã cào dữ liệu thành công!",f.disabled=!1,E.disabled=!1,B.disabled=!1,S.disabled=!1,l.disabled=!1):e.action==="htmlScrapingComplete"?t.textContent=`Đã cào HTML thành công! File: ${e.fileName}`:e.action==="htmlScrapingError"?t.textContent=`Lỗi cào HTML: ${e.error}`:e.action==="scheduleJSONScrapingComplete"?t.textContent=`Đã cào JSON lịch học thành công! File: ${e.fileName}`:e.action==="scheduleJSONScrapingError"?t.textContent=`Lỗi cào JSON lịch học: ${e.error}`:e.action==="gradeJSONScrapingComplete"?t.textContent="Đã cào JSON điểm thành công! File tổng hợp đã được tải xuống.":e.action==="gradeJSONScrapingError"?t.textContent=`Lỗi cào JSON điểm: ${e.error}`:e.action==="gradeJSONScrapingProgress"?t.textContent=`Đang cào điểm... (${e.current}/${e.total})`:e.action==="attendanceJSONScrapingComplete"?t.textContent="Đã cào JSON điểm danh thành công! File tổng hợp đã được tải xuống.":e.action==="attendanceJSONScrapingError"?t.textContent=`Lỗi cào JSON điểm danh: ${e.error}`:e.action==="attendanceJSONScrapingProgress"&&(t.textContent=`Đang cào điểm danh... (${e.current}/${e.total})`)});const i=document.getElementById("autoScrapeEnabled"),u=document.getElementById("autoUploadEnabled"),m=document.getElementById("uploadTargetUrl"),p=document.getElementById("phase1Hours"),d=document.getElementById("phase2Hours"),g=document.getElementById("settingsGradeUrls"),h=document.getElementById("settingsAttendanceUrls"),w=document.getElementById("saveSettingsBtn"),o=document.getElementById("saveStatus");function v(e){return(e??[]).join(`
`)}function C(e){return(e??"").split(`
`).map(a=>a.trim()).filter(Boolean)}i&&u&&m&&chrome.storage.sync.get(["autoScrapeEnabled","autoUploadEnabled","uploadTargetUrl","runIntervals","gradeUrls","attendanceUrls"],e=>{i.checked=!!e.autoScrapeEnabled,u.checked=!!e.autoUploadEnabled,m.value=e.uploadTargetUrl||"https://v0-web-app-logic.vercel.app/upload";const a=e.runIntervals?.phase1Hours??12,c=e.runIntervals?.phase2Hours??24;p&&(p.value=String(a)),d&&(d.value=String(c)),g&&(g.value=v(e.gradeUrls)),h&&(h.value=v(e.attendanceUrls))});w?.addEventListener("click",()=>{const e={phase1Hours:Number(p?.value||12),phase2Hours:Number(d?.value||24),phase3Hours:Number(d?.value||24)},a={autoScrapeEnabled:!!i?.checked,autoUploadEnabled:!!u?.checked,uploadTargetUrl:m?.value?.trim()||"https://v0-web-app-logic.vercel.app/upload",runIntervals:e,gradeUrls:C(g?.value),attendanceUrls:C(h?.value)};chrome.storage.sync.set(a,()=>{if(chrome.runtime.lastError){o&&(o.textContent=`Lỗi: ${chrome.runtime.lastError.message}`);return}o&&(o.textContent="Đã lưu cài đặt!",setTimeout(()=>{o&&(o.textContent="")},1500))})});
